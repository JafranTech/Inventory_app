using System;using System;

using System.Linq;using System.Linq;

using System.Windows.Forms;using System.Windows.Forms;

using System.Drawing;using System.Drawing;

using InventoryApp.Services;using InventoryApp.Services;

using InventoryApp.Models;using InventoryApp.Models;

using InventoryApp.Data;

namespace InventoryApp.UserControls

namespace InventoryApp.UserControls{

{    public partial class SoldProductsControl : UserControl

    public partial class SoldProductsControl : UserControl    {

    {        private readonly CsvDataService _dataService;

        private readonly CsvDataService _dataService;        private readonly InventoryApp.Data.InventoryManager _manager;

        private readonly InventoryManager _manager;        private readonly DataGridView gridSales;

        private readonly DataGridView gridSales;        private readonly Button btnRefresh;

        private readonly Button btnRefresh;        private readonly ComboBox cmbDateFilter;

        private readonly ComboBox cmbDateFilter;        private readonly ComboBox cmbCategory;

        private readonly ComboBox cmbCategory;        private readonly TextBox txtProductSearch;

        private readonly TextBox txtProductSearch;

        public SoldProductsControl(InventoryApp.Data.InventoryManager manager)

        public SoldProductsControl(InventoryManager manager)        {

        {            _dataService = new CsvDataService();

            _dataService = new CsvDataService();            _manager = manager ?? throw new ArgumentNullException(nameof(manager));

            _manager = manager ?? throw new ArgumentNullException(nameof(manager));            

                        // Initialize control

            // Initialize control            this.Dock = DockStyle.Fill;

            this.Dock = DockStyle.Fill;            this.BackColor = Color.WhiteSmoke;

            this.BackColor = Color.WhiteSmoke;            this.Padding = new Padding(20);

            this.Padding = new Padding(20);

            var panel = new TableLayoutPanel

            var mainPanel = new TableLayoutPanel            {

            {                Dock = DockStyle.Fill,

                Dock = DockStyle.Fill,                RowCount = 2,

                RowCount = 2,                ColumnCount = 1,

                ColumnCount = 1,                Padding = new Padding(10)

                Padding = new Padding(10)            };

            };            panel.RowStyles.Add(new RowStyle(SizeType.AutoSize));

            mainPanel.RowStyles.Add(new RowStyle(SizeType.AutoSize));            panel.RowStyles.Add(new RowStyle(SizeType.Percent, 100));

            mainPanel.RowStyles.Add(new RowStyle(SizeType.Percent, 100));

            // Top panel for controls

            // Create filters panel            var topPanel = new FlowLayoutPanel

            var filtersPanel = new FlowLayoutPanel            {

            {                Dock = DockStyle.Fill,

                FlowDirection = FlowDirection.LeftToRight,                FlowDirection = FlowDirection.LeftToRight,

                AutoSize = true,                AutoSize = true,

                Margin = new Padding(0, 0, 0, 10)                Margin = new Padding(0, 0, 0, 10)

            };            };



            // Add date filter            // Add date filter

            var lblDate = new Label { Text = "Date:", AutoSize = true, Margin = new Padding(0, 3, 5, 0) };            cmbDateFilter = new ComboBox

            cmbDateFilter = new ComboBox            {

            {                Width = 200,

                Width = 150,                DropDownStyle = ComboBoxStyle.DropDownList,

                DropDownStyle = ComboBoxStyle.DropDownList,                Margin = new Padding(0, 0, 10, 0)

                Margin = new Padding(0, 0, 20, 0)            };

            };            cmbDateFilter.Items.AddRange(new object[] {

            cmbDateFilter.Items.AddRange(new object[] {                "All Time",

                "All Time",                "Today",

                "Today",                "Last 7 Days",

                "Last 7 Days",                "Last 30 Days"

                "Last 30 Days"            });

            });            cmbDateFilter.SelectedIndex = 0;

            cmbDateFilter.SelectedIndexChanged += (s, e) => LoadSales();

            // Add category filter            panel.Controls.Add(cmbDateFilter);

            var lblCategory = new Label { Text = "Category:", AutoSize = true, Margin = new Padding(0, 3, 5, 0) };

            cmbCategory = new ComboBox            // Add refresh button

            {            btnRefresh = new Button

                Width = 150,            {

                DropDownStyle = ComboBoxStyle.DropDownList,                Text = "ðŸ”„ Refresh",

                Margin = new Padding(0, 0, 20, 0)                Width = 100,

            };                Height = 35,

            cmbCategory.Items.Add("All Categories");                BackColor = Color.FromArgb(51, 51, 76),

            cmbCategory.Items.AddRange(_manager.GetCategories().ToArray());                ForeColor = Color.White,

            cmbCategory.SelectedIndex = 0;                FlatStyle = FlatStyle.Flat

            };

            // Add product search            btnRefresh.FlatAppearance.BorderSize = 0;

            var lblProduct = new Label { Text = "Product:", AutoSize = true, Margin = new Padding(0, 3, 5, 0) };            btnRefresh.Click += (s, e) => LoadSales();

            txtProductSearch = new TextBox

            {            topPanel.Controls.Add(cmbDateFilter);

                Width = 150,            topPanel.Controls.Add(btnRefresh);

                Margin = new Padding(0, 0, 20, 0)            panel.Controls.Add(topPanel, 0, 0);

            };

            try { txtProductSearch.PlaceholderText = "Search by name/ID"; } catch { }            // Create grid

            gridSales = new DataGridView

            // Add refresh button            {

            btnRefresh = new Button                Dock = DockStyle.Fill,

            {                AllowUserToAddRows = false,

                Text = "ðŸ”„ Refresh",                AllowUserToDeleteRows = false,

                Width = 100,                ReadOnly = true,

                Height = 35,                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,

                BackColor = Color.FromArgb(51, 51, 76),                BackgroundColor = Color.White,

                ForeColor = Color.White,                BorderStyle = BorderStyle.None,

                FlatStyle = FlatStyle.Flat,                RowHeadersVisible = false,

                Margin = new Padding(0)                SelectionMode = DataGridViewSelectionMode.FullRowSelect,

            };                DefaultCellStyle = new DataGridViewCellStyle 

            btnRefresh.FlatAppearance.BorderSize = 0;                {

                    Font = new Font("Segoe UI", 11F, FontStyle.Regular),

            // Add all filters to panel                    Padding = new Padding(5)

            filtersPanel.Controls.AddRange(new Control[] {                },

                lblDate, cmbDateFilter,                ColumnHeadersDefaultCellStyle = new DataGridViewCellStyle

                lblCategory, cmbCategory,                {

                lblProduct, txtProductSearch,                    Font = new Font("Segoe UI", 11F, FontStyle.Bold),

                btnRefresh                    BackColor = Color.FromArgb(51, 51, 76),

            });                    ForeColor = Color.White,

                    Padding = new Padding(5)

            // Create sales grid                },

            gridSales = new DataGridView                RowTemplate = { Height = 35 },

            {                AlternatingRowsDefaultCellStyle = new DataGridViewCellStyle

                Dock = DockStyle.Fill,                {

                AllowUserToAddRows = false,                    BackColor = Color.FromArgb(245, 245, 250)

                AllowUserToDeleteRows = false,                }

                ReadOnly = true,            };

                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,

                BackgroundColor = Color.White,            gridSales.DefaultCellStyle.SelectionBackColor = Color.FromArgb(51, 51, 76);

                BorderStyle = BorderStyle.None,            gridSales.DefaultCellStyle.SelectionForeColor = Color.White;

                RowHeadersVisible = false,

                SelectionMode = DataGridViewSelectionMode.FullRowSelect,            panel.Controls.Add(gridSales, 0, 1);

                DefaultCellStyle = new DataGridViewCellStyle             this.Controls.Add(panel);

                {

                    Font = new Font("Segoe UI", 11F, FontStyle.Regular),            // subscribe to inventory updates so sales list refreshes when new sales are recorded

                    Padding = new Padding(5)            _manager.InventoryUpdated += LoadSales;

                },            LoadSales();

                ColumnHeadersDefaultCellStyle = new DataGridViewCellStyle        }

                {

                    Font = new Font("Segoe UI", 11F, FontStyle.Bold),        private void LoadSales()

                    BackColor = Color.FromArgb(51, 51, 76),        {

                    ForeColor = Color.White,            var sales = _manager.GetSales().ToList();

                    Padding = new Padding(5)

                },            // Apply date filter

                RowTemplate = { Height = 35 },            if (cmbDateFilter.SelectedItem != null)

                AlternatingRowsDefaultCellStyle = new DataGridViewCellStyle            {

                {                switch (cmbDateFilter.SelectedItem.ToString())

                    BackColor = Color.FromArgb(245, 245, 250)                {

                }                    case "Today":

            };                        sales = sales.Where(s => s.SaleDate.Date == DateTime.Today).ToList();

                        break;

            gridSales.DefaultCellStyle.SelectionBackColor = Color.FromArgb(51, 51, 76);                    case "Last 7 Days":

            gridSales.DefaultCellStyle.SelectionForeColor = Color.White;                        sales = sales.Where(s => s.SaleDate >= DateTime.Today.AddDays(-7)).ToList();

                        break;

            // Add controls to main panel                    case "Last 30 Days":

            mainPanel.Controls.Add(filtersPanel, 0, 0);                        sales = sales.Where(s => s.SaleDate >= DateTime.Today.AddDays(-30)).ToList();

            mainPanel.Controls.Add(gridSales, 0, 1);                        break;

            this.Controls.Add(mainPanel);                }

            }

            // Wire up events

            btnRefresh.Click += (s, e) => LoadSales();            // Apply category filter

            cmbDateFilter.SelectedIndexChanged += (s, e) => LoadSales();            if (cmbCategory.SelectedItem?.ToString() != "All Categories")

            cmbCategory.SelectedIndexChanged += (s, e) => LoadSales();            {

            txtProductSearch.TextChanged += (s, e) => LoadSales();                var category = cmbCategory.SelectedItem.ToString();

                var productsInCategory = _manager.GetProducts()

            // Select initial values                    .Where(p => p.Category == category)

            cmbDateFilter.SelectedIndex = 0;                    .Select(p => p.Id)

                    .ToList();

            // Subscribe to inventory updates                sales = sales.Where(s => productsInCategory.Contains(s.ProductId)).ToList();

            _manager.InventoryUpdated += LoadSales;            }

            LoadSales();

        }            // Apply product search

            var searchText = txtProductSearch.Text.Trim().ToLower();

        private void LoadSales()            if (!string.IsNullOrEmpty(searchText))

        {            {

            var sales = _manager.GetSales().ToList();                sales = sales.Where(s => 

                    s.ProductName.ToLower().Contains(searchText) || 

            // Apply date filter                    s.ProductId.ToString() == searchText

            if (cmbDateFilter.SelectedItem != null)                ).ToList();

            {            }

                switch (cmbDateFilter.SelectedItem.ToString())

                {            // Calculate totals for filtered sales

                    case "Today":            var totalQuantity = sales.Sum(s => s.QuantitySold);

                        sales = sales.Where(s => s.SaleDate.Date == DateTime.Today).ToList();            var totalRevenue = sales.Sum(s => s.TotalPrice);

                        break;

                    case "Last 7 Days":            // Create view model that includes both sales and totals

                        sales = sales.Where(s => s.SaleDate >= DateTime.Today.AddDays(-7)).ToList();            var rows = sales

                        break;                .OrderByDescending(s => s.SaleDate)

                    case "Last 30 Days":                .Select(s => new

                        sales = sales.Where(s => s.SaleDate >= DateTime.Today.AddDays(-30)).ToList();                {

                        break;                    IsTotal = false,

                }                    Transaction = $"#{s.Id}",

            }                    Date = s.SaleDate.ToString("g"),

                    Product = s.ProductName,

            // Apply category filter                    ProductId = s.ProductId,

            if (cmbCategory.SelectedItem?.ToString() != "All Categories")                    Category = _manager.GetProducts().FirstOrDefault(p => p.Id == s.ProductId)?.Category ?? "",

            {                    Quantity = s.QuantitySold,

                var category = cmbCategory.SelectedItem?.ToString() ?? "";                    UnitPrice = s.TotalPrice / s.QuantitySold,

                var productsInCategory = _manager.GetProducts()                    Total = s.TotalPrice

                    .Where(p => p.Category == category)                })

                    .Select(p => p.Id)                .ToList();

                    .ToList();

                sales = sales.Where(s => productsInCategory.Contains(s.ProductId)).ToList();            // Add total row

            }            rows.Add(new

            {

            // Apply product search                IsTotal = true,

            var searchText = txtProductSearch.Text.Trim().ToLower();                Transaction = "TOTAL",

            if (!string.IsNullOrEmpty(searchText))                Date = "",

            {                Product = $"{rows.Count} sales",

                sales = sales.Where(s =>                 ProductId = 0,

                    s.ProductName.ToLower().Contains(searchText) ||                 Category = "",

                    s.ProductId.ToString().Contains(searchText)                Quantity = totalQuantity,

                ).ToList();                UnitPrice = 0M,

            }                Total = totalRevenue

            });

            // Calculate totals for filtered sales

            var totalQuantity = sales.Sum(s => s.QuantitySold);            gridSales.DataSource = rows;

            var totalRevenue = sales.Sum(s => s.TotalPrice);

            if (gridSales.Columns.Count > 0)

            // Create view model that includes both sales and totals            {

            var rows = sales                // Format currency columns

                .OrderByDescending(s => s.SaleDate)                gridSales.Columns["UnitPrice"].DefaultCellStyle.Format = "C2";

                .Select(s => new                gridSales.Columns["Total"].DefaultCellStyle.Format = "C2";

                {                

                    IsTotal = false,                // Right-align numeric columns

                    Transaction = $"#{s.Id}",                gridSales.Columns["Quantity"].DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight;

                    Date = s.SaleDate.ToString("g"),                gridSales.Columns["UnitPrice"].DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight;

                    Product = s.ProductName,                gridSales.Columns["Total"].DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight;

                    ProductId = s.ProductId,

                    Category = _manager.GetProducts().FirstOrDefault(p => p.Id == s.ProductId)?.Category ?? "",                // Hide IsTotal column

                    Quantity = s.QuantitySold,                gridSales.Columns["IsTotal"].Visible = false;

                    UnitPrice = s.TotalPrice / s.QuantitySold,

                    Total = s.TotalPrice                // Format total row

                })                foreach (DataGridViewRow row in gridSales.Rows)

                .ToList();                {

                    var isTotal = (bool)row.Cells["IsTotal"].Value;

            // Add total row                    if (isTotal)

            rows.Add(new                    {

            {                        row.DefaultCellStyle.BackColor = Color.FromArgb(51, 51, 76);

                IsTotal = true,                        row.DefaultCellStyle.ForeColor = Color.White;

                Transaction = "TOTAL",                        row.DefaultCellStyle.Font = new Font(gridSales.DefaultCellStyle.Font, FontStyle.Bold);

                Date = "",                    }

                Product = $"{rows.Count} sales",                }

                ProductId = 0,            }

                Category = "",        }

                Quantity = totalQuantity,    }

                UnitPrice = 0M,}
                Total = totalRevenue
            });

            gridSales.DataSource = rows;

            if (gridSales.Columns.Count > 0)
            {
                // Format currency columns
                gridSales.Columns["UnitPrice"].DefaultCellStyle.Format = "C2";
                gridSales.Columns["Total"].DefaultCellStyle.Format = "C2";
                
                // Right-align numeric columns
                gridSales.Columns["ProductId"].DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight;
                gridSales.Columns["Quantity"].DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight;
                gridSales.Columns["UnitPrice"].DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight;
                gridSales.Columns["Total"].DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight;

                // Hide IsTotal and ProductId columns
                gridSales.Columns["IsTotal"].Visible = false;
                gridSales.Columns["ProductId"].Visible = false;

                // Format total row
                foreach (DataGridViewRow row in gridSales.Rows)
                {
                    if ((bool)row.Cells["IsTotal"].Value)
                    {
                        row.DefaultCellStyle.BackColor = Color.FromArgb(51, 51, 76);
                        row.DefaultCellStyle.ForeColor = Color.White;
                        row.DefaultCellStyle.Font = new Font(gridSales.DefaultCellStyle.Font, FontStyle.Bold);
                    }
                }
            }
        }
    }
}